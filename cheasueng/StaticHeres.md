# javascript는 느리다?

정적 타입 언어(c++, c, rust, zig 등)보다 느린것이 사실입니다. 아무래도 동적 언어라는 것이 그런거죠. 그런데 이 동적 언어를 type으로서 빠르게 만든 것이 있습니다.  
그것은 바로 v8입니다. (사실 모든 javascript엔진이 그러긴 합니다.) v8은 ignite와 turbofan이라는 방식을 통하여 타입추론을 이용하여 JIT컴파일러를 통해 기계어로 생성시켜 최적화에 최적화를 거듭나 빠르게 만듭니다. 이젠 충분히 이것으로 데스크탑 앱, 모바일 앱을 만들기에 충분해졌죠. 하지만 아쉬운 것은 아직도 화면을 그리는 것들은 모두 정적 언어들이 처리한 다는 것이죠.

속도가 빠르게 하기 위해서는 프로그래밍 언어가 어떻게 작동하는지 알아야 합니다. 저희가 OS에서 배웠듯이 미리 그 메모리를 사용하기 위해서는 커널에 메모리를 사용하고 싶다고 허락을 받아야 합니다. 동적 언어는 v8, jvm, pypy등과 같은 엔진들이 미리 메모리를 자동으로 할당하고 반환합니다. 아무래도 이러한 동작을 하면 오버헤드가 커집니다. 여기서 크게 2가지 빠르게 하는 방법을 유추할 수 있죠. 첫번째로는 정적타입언어를 사용하는 것입니다. 메모리를 빌리거나 반납하는 모든 활동을 개발자에게 제어시키면 속도가 빨라집니다. 두번째로는 오버헤드를 줄이는 것입니다. 이는 엔진 개발자들이 열심히 최적화를 하고 있는 중이죠.

## 그렇다면 지금 당장 javascript를 빠르게 만드는 방법은 무엇이 있을까?

일단 FFI라는 방식이 있습니다. 정적언어는 미리 AOT로서 파일을 만들어 두기 때문에 다른 언어에서 bridge를 통하여 그 함수를 부를 수 있습니다. 예를 들어서 sqlite는 C로 짜여 있지만, javascript에서 불러낼 수 있다거나, python에서 C로 짜여진 numpy를 불러낸다는 등을 들 수 있네요. 하지만 이는 두가지 언어에 대해서 잘 알아야 한다는 단점이 있습니다. 저는 개인적으로 c++을 공부하고 싶지는 않네요.

또 다른 방식으로 WASM이 있습니다. 최근 나온 스택중 하나이며, WASM은 공용화된 기계어를 통하여 엔진에서 실행한다는 점입니다. C++, rust는 물론 java, python까지 이를 이용할 수 있습니다. 그래서 최근 rust로 풀 스택 사이트를 만든다거나, python을 가지고 javascript를 대체하려는 노력들이 보입니다. 이는 다른 언어를 사용하는 사람들이 웹에서나 모든 다른 곳(window, linux, mac뿐 아니라 android, ios까지)에서 사용하려는 시도입니다.

## 이번에 새로운 시도를 하는 곳이 있습니다.

바로 React Native에서 돌아가는 harmes가 그 시도를 하고 있는 중이죠. 위에서 거대한 서사를 썼다싶이 타입을 이용하여 javascript를 최적화하려고 합니다.  
harmes는 v8, jsc(JavasScriptCore)처럼 javasript 엔진 중 하나입니다. 이 엔진는 2018년부터 성능에 대한 최적화를 본격적으로 하고 있습니다. 최근 국내에서는 Toss가 React Native를 사용하면서 가져온 변화에 대해서 이야기를 해주며 시장을 한번 더 뒤흔들었었죠. 최근 Hermes팀이 한번더 세상을 변화시킬 움직임을 보여주기 시작합니다. Amazon이 이 팀을 도와주는 것은 한목 더해 보이네요.

최근 [이 영상](https://www.youtube.com/watch?v=q-xKYA0EO-c)에서 해당 내용이 어떻게 이루어졌는가에 대해 자세하게 알 수 있습니다.

### 대체 어떻게 강제화시킬까?

여기는 엔진을 만드는 곳입니다. 다시 말하면 소스코드를 가지고 더 빠른 코드로 만드는 곳인 것이죠. 이들은 typescript나 flow의 불완전성(부적절한 코드)를 보완할 수 있습니다. 흔히 실수할 수 있는 다음과 같은 코드를 보시죠.

```ts
function addXY(x: number, y: number) {
  return x + y;
}

let a: number[] = [10, 20, 30];

addXY(a[10], a[11]);
```

위와 같은 코드는 undefined + undefined임에도 불구하고 계산하려고 하죠. 이는 javascript가 가지고 있는 특성 때문인데(사실 web의 특성이죠) 어떠한 상황이든 돌아가기 위해 노력하는 모습인거죠. Hermes는 이를 runtime에서 던져줍니다!! 이 팀은 Typescript와 Flow를 모두 지원하며, 점진적으로 증가시키려고 합니다.

그렇다면 우리가 가장 걱정해야할 것은 기존의 javascript를 파괴시키는지입니다. 저번주 주제에서도 봤듯이 javascript를 강제하고 복잡성을 추가하는 순간 코드를 건들기 힘들어집니다. 이 팀도 그것을 잘 알고 있는지 단순히 ruuner입장에서 옵션으로 넣고, 단순히 Teypscript나 Flow의 타입 시스템에 runtime에서 강한 타입으로 추진하려고만 하는 것입니다.

### 추가적으로 성능을 높이는 방법(최적화)

이 팀은 성능을 높이기 위해서 FFI바인딩을 더욱 빠르게 만들고자 합니다. 근본은 cross platform인것처럼 FFI를 정말 많이 사용하게 되는데(bluetooth, wifi 등) 이는 결국 FFI의 사용을 하기 때문에 overhead를 줄인다면 당연히 앱의 성능을 올라갑니다. 최종적으로 목표하고자 하는 것은 Zero-cost FFI입니다. 이는 내부 hermes에서 동작하는 엔진 중 하나인 JSI에서 native PAI를 부르는 것입니다.
이를 사용하면 단순히 15~80배 빨라진다고 합니다.

# 마무리

최근 javascript엔진을 다루는 곳에서 modern함을 유지하려고 노력하는 모습이 보입니다. vite처럼 go 대신 rust를 적극적으로 차용하려고 하기도하고, safe, unsafe를 javascript에 도입하며, native function을 1급 시민의 언어로 오버헤딩 없이 넣으려는 노력 등 javascript를 좀 더 모던하며, 성능이 좋은 언어로 만들기 위한 노력을 보이고 있습니다.

javascript는 점차 만능이 되어가고 있습니다. 강력한 Web의 생태계가 없어지지 않는 이상 이 생태계는 점차 확장되고 커질 것입니다. 우리는 javascript의 장점들을 가지고 더욱 활용을 해야합니다. 다양한 시도, 다양한 접근을 통해서 개발하는 사람이되면 좋을 것 같습니다.
